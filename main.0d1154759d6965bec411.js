(()=>{"use strict";const e=document.querySelector(".popup_type_image"),t=(e.querySelector(".popup__image"),e.querySelector(".popup__image-name"),document.querySelector(".profile")),s=(t.querySelector(".profile__edit-avatar"),t.querySelector(".profile__edit-button")),i=document.forms.editProfileForm,r=(document.forms.editAvatarForm,t.querySelector(".profile__add-button")),n=document.forms.addCardForm;class a{constructor(e,t,s,i,r,n,a){this._name=e.name,this._link=e.link,this._likes=e.likes,this._id=e._id,this._ownerId=e.owner._id,this._myId=s,this._template=t,this._handleCardClick=i,this._handleButtonTrashClick=r,this._deleteLike=a,this._putLike=n,this._cardElement=this._getCardTemplate(),this._buttonTrash=this._cardElement.querySelector(".card__trash-button"),this._cardImage=this._cardElement.querySelector(".card__image"),this._heartCount=this._cardElement.querySelector(".card__like-count"),this._buttonLike=this._cardElement.querySelector(".card__like-button")}_isLiked(){return this._likes.find((e=>e._id===this._myId))}_getCardTemplate(){return document.querySelector(this._template).content.querySelector(".card").cloneNode(!0)}_fillTemplate(){this._cardElement.querySelector(".card__title").textContent=this._name,this._cardImage.src=this._link,this._cardImage.alt=this._name,this._isLiked()&&this._buttonLike.classList.add("card__like-button_active"),this._heartCount.textContent=this._likes.length}_setEventListeners(){this._buttonLike.addEventListener("click",(()=>{this._isLiked()?this._deleteLike(this._id):this._putLike(this._id)})),this._ownerId!==this._myId?this._buttonTrash.remove():this._buttonTrash.addEventListener("click",(()=>{this._handleButtonTrashClick(this._id)})),this._cardImage.addEventListener("click",(()=>{this._handleCardClick(this._name,this._link)}))}updateLikes(e){this._likes=e.likes,this._heartCount.textContent=this._likes.length,this._buttonLike.classList.toggle("card__like-button_active")}deleteCard(){this._cardElement.remove()}createCard(){return this._fillTemplate(),this._setEventListeners(),this._cardElement}}class o{constructor(e){this._element=document.querySelector(e),this._handleEscClose=this._handleEscClose.bind(this)}open(){this._element.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._element.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){"Escape"===e.key&&this.close()}setEventListeners(){this._element.addEventListener("mousedown",(e=>{e.target.classList.contains("popup_opened")&&this.close(),e.target.classList.contains("popup__close-button")&&this.close()}))}}class h extends o{constructor(e,t){super(e),this._formElement=this._element.querySelector(".popup__form"),this._buttonSubmit=this._formElement.querySelector(".popup__submit-btn"),this._textButtonSubmit=this._buttonSubmit.textContent,this._handleSubmit=t,this._inputValues={},this._inputs=Array.from(this._formElement.elements)}_getInputValues(){this._inputs.forEach((e=>{this._inputValues[e.name]=e.value}))}close(){super.close(),this._formElement.reset()}setInputValues(e){this._inputs.forEach((t=>{t.value=e[t.name]}))}setEventListeners(){super.setEventListeners(),this._formElement.addEventListener("submit",(e=>{e.preventDefault(),this._getInputValues(),this._handleSubmit(this._inputValues)}))}renderLoading(e){this._buttonSubmit.textContent=e?"Сохранение...":this._textButtonSubmit}}const l={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__submit-button",inactiveButtonAttribute:"disabled",inputErrorClass:"popup__input_invalid",errorClass:"popup__input-error_active"};class _{constructor(e,t){this._selectorsSet=e,this._form=t,this._buttonSubmit=this._form.querySelector(this._selectorsSet.submitButtonSelector),this._inputsList=Array.from(this._form.querySelectorAll(this._selectorsSet.inputSelector))}_hideInputError(e){const t=this._form.querySelector(`.${e.id}-error`);t.textContent="",t.classList.remove(this._selectorsSet.errorClass),e.classList.remove(this._selectorsSet.inputErrorClass)}_showInputError(e,t){const s=this._form.querySelector(`.${e.id}-error`);s.textContent=t,s.classList.add(this._selectorsSet.errorClass),e.classList.add(this._selectorsSet.inputErrorClass)}_submitBtnState(){this._form.checkValidity()?this._buttonSubmit.removeAttribute(this._selectorsSet.inactiveButtonAttribute):this._buttonSubmit.setAttribute(this._selectorsSet.inactiveButtonAttribute,!0)}_checkInputValidity(e){this._submitBtnState(),e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_setEventListeners(){this._inputsList.forEach((e=>{e.addEventListener("input",(()=>this._checkInputValidity(e)))})),this._form.addEventListener("reset",(()=>{setTimeout((()=>{this._submitBtnState()})),this._inputsList.forEach((e=>{this._form.addEventListener("reset",(()=>this._hideInputError(e)))}))}))}enableValidation(){this._form.addEventListener("submit",(e=>{e.preventDefault()})),this._setEventListeners()}}function d(e,t){const s=new a(e,"#card",p.getUserId(),((e,t)=>{b.open({name:e,link:t})}),(e=>{m.open(),m.setSubmit((()=>{u.deleteCard(e).then((()=>{s.deleteCard(),m.close()})).catch((e=>{alert(e)}))}))}),(e=>{u.putLike(e).then((e=>{s.updateLikes(e)})).catch((e=>{alert(e)}))}),(e=>{u.deleteLike(e).then((e=>{s.updateLikes(e)})).catch((e=>{alert(e)}))}));t.addItem(s.createCard())}new _(l,i).enableValidation(),new _(l,n).enableValidation(),new _(l,formEditAvatar).enableValidation();const c=new class{constructor(e,t){let{items:s,renderer:i}=e;this._items=s,this._renderer=i,this._container=document.querySelector(t)}renderItems(){this._items.forEach((e=>{this._renderer(e)}))}addItem(e){this._container.prepend(e)}}((e=>{d(e,c)}),".cards"),u=new class{constructor(e){this._baseUrl=e.baseUrl,this._headers=e.headers}_checkResponse(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}getUserInfo(){return fetch(`${this._baseUrl}/users/me`,{headers:this._headers}).then(this._checkResponse)}editUserInfo(e,t){return fetch(`${this._baseUrl}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e,about:t})}).then(this._checkResponse)}editAvatar(e){return fetch(`${this._baseUrl}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then(this._checkResponse)}addNewCard(e,t){return fetch(`${this._baseUrl}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:e,link:t})}).then(this._checkResponse)}getCardsInfo(){return fetch(`${this._baseUrl}/cards`,{headers:this._headers}).then(this._checkResponse)}deleteCard(e){return fetch(`${this._baseUrl}/cards/${e}`,{method:"DELETE",headers:this._headers})}putLike(e){return fetch(`${this._baseUrl}/cards/likes/${e}`,{method:"PUT",headers:this._headers}).then(this._checkResponse)}deleteLike(e){return fetch(`${this._baseUrl}/cards/likes/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-64",headers:{authorization:"0b562ac8-f292-439f-a6fd-a16812416d74","Content-Type":"application/json"}});Promise.all([u.getUserInfo(),u.getCardsInfo()]).then((e=>{let[t,s]=e;p.setUserId(t._id),p.setUserInfo(t.name,t.about),p.setAvatar(t.avatar),c.renderItems(s)})).catch((e=>{alert(e)}));const m=new class extends o{constructor(e){super(e),this._form=this._element.querySelector(".popup__form")}setSubmit(e){this._handleSubmit=e}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._handleSubmit()}))}}(".popup_type_delete");m.setEventListeners();const p=new class{constructor(e){let{name:t,job:s,avatar:i}=e;this._titleElement=document.querySelector(t),this._subTitleElement=document.querySelector(s),this._avatarElement=document.querySelector(i)}setUserId(e){this._id=e}getUserId(){return this._id}getUserInfo(){return{title:this._titleElement.textContent,subtitle:this._subTitleElement.textContent}}setAvatar(e){this._avatarElement.src=e}setUserInfo(e,t){this._titleElement.textContent=e,this._subTitleElement.textContent=t}}({name:".profile__title",job:".profile__subtitle",avatar:".profile__avatar"}),b=new class extends o{constructor(e){super(e),this._image=this._element.querySelector(".popup__image"),this._imageName=this._element.querySelector(".popup__image-name")}open(e){let{name:t,link:s}=e;this._image.src=s,this._image.alt=t,this._imageName.textContent=t,super.open()}}(".popup_type_image");b.setEventListeners();const E=new h(".popup_type_edit-avatar",(e=>{E.renderLoading(!0),u.editAvatar(e.avatarLink).then((e=>{p.setAvatar(e.avatar)})).then((()=>{E.close()})).catch((e=>{alert(e)})).finally((()=>{E.renderLoading(!1)}))}));E.setEventListeners();const f=new h(".popup_type_edit-profile",(e=>{f.renderLoading(!0),u.editUserInfo(e.title,e.subtitle).then((e=>{p.setUserInfo(e.name,e.about)})).then((()=>{f.close()})).catch((e=>{alert(e)})).finally((()=>{f.renderLoading(!1)}))}));f.setEventListeners();const v=new h(".popup_type_add-card",(e=>{v.renderLoading(!0),u.addNewCard(e.cardTitle,e.cardLink).then((e=>{d(e,c)})).then((()=>{v.close()})).catch((e=>{alert(e)})).finally((()=>{v.renderLoading(!1)}))}));v.setEventListeners(),buttonEditAvatar.addEventListener("click",(()=>{E.open()})),s.addEventListener("click",(()=>{f.open();const e=p.getUserInfo();f.setInputValues(e)})),r.addEventListener("click",(()=>{v.open()}))})();